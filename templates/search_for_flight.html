<!DOCTYPE html>
<html>
  <head>
    <script src="/static/scripts/sorttable.js"></script>
    <link rel="stylesheet" href="/static/styles/styles.css">
  </head>
  <body>

    <div id="sidebar" class="sidenav">
      <div class="profile">
        {%if login%}
          {%if 'profile' in login%}
            <img src="{{login['profile']}}" alt="User" />
          {%endif%}
        {%else%}
        <img src="/static/images/visitor_profile.png" alt="User" />
        {%endif%}
        {%if login%}
        <div id="uname"> <h3>{{login['username']}}</h3> </div>
        {%else%}
        <div id="uname"> <h3>Visitor</h3> </div>
        {%endif%}
      </div>
      <div id="menu">
        {%if login%}
        <button class="collapsible" onclick="window.location.href='/account'">My Account</button>
        <button class="collapsible" onclick="window.location.href='/account/logout'">Log Out</button>
        {%else%}
        <button class="collapsible" onclick="window.location.href='/account/login'">Log In</button>
        <button class="collapsible" onclick="window.location.href='/account/register'">Sign Up</button>
        {%endif%}
        <button class="collapsible" onclick="window.location.href='/public/search_flight'">View Public Info</button>
        <button class="collapsible" onclick="window.location.href='/public/home'" >About</button>
      </div>
      <div id="toggle">
        <button id="tbutton" onclick="toggleSidebar()"> << </button>
      </div>
    </div>

    <div id ="header" class="header">
        <h1>Search for Upcoming Flights</h1>
      </div>

    <div id="main" class="main">
      <div class="topnav">
        <a href="/public/status">View Flight Status</a> 
        <a href="/public/search_flight">Search for Flights</a>
        {%if login%}
          {%if login['type']=='customer'%}
            <a href="/customer/my_flights">My Flights</a> 
            <a href="/customer/spending">Track My Spending</a>
          {%endif%}
                    {%if login['type']=='agent'%}
            <a href="/agent/commission">My Commission</a> 
            <a href="/agent/customers">View Top Customers</a>
            <a href="/agent/my_flights">View My Flights</a>
          {%endif%}
          {%if login['type']=='staff'%}
            <a href="/staff/my_flights">My Flights</a> 
            <a href="/staff/manage">Manage Info</a> 
            <a href="/staff/stats">View Statistics</a>            
            <a href="/staff/accounts">Manage Accounts</a>
          {%endif%}
        {%endif%}
      </div>
      <div class="main_content">
        <form id="query_form" action="">
          <div>
          <label for="airline_name">Airline: </label> 
          <select id="airline_name" name="airline_name">
              <option value=""></option>
              {% for a in airlines %}
              <option value="{{a}}">{{a}}</option>
              {% endfor %}
          </select>
          </div>
  
          <div>
          <label for="departure_airport">From: </label>
          <select id="departure_airport" name="departure_airport">
              <option value=""></option>
              {% for a in airports %}
              <option value="{{a}}">{{a}}</option>
              {% endfor %}
          </select> 
          </div>  
  
          <div>
          <label for="arrival_airport">To: </label>
          <select id="arrival_airport" name="arrival_airport">
              <option value=""></option>
              {% for a in airports %}
              <option value="{{a}}">{{a}}</option>
              {% endfor %}
          </select>
          </div>  
  
          <div>
          <label for="DATE(departure_time)">Departing</label>
          <input type="date" id="DATE(departure_time)" name="DATE(departure_time)">
          </div>
  
          <div>
          <label for="DATE(arrival_time)">Arriving</label>
          <input type="date" id="DATE(arrival_time)" name="DATE(arrival_time)"><br>
          </div>
  
          
          <div>
          <input type="submit" value="Search">
          </div>
        </form> 
        <table class="sortable">
          <thead>
              <tr>
                  <th>Airline</th>
                  <th>Flight Number</th>
                  <th>Departure</th>
                  <th>Arrival</th>
                  <th>Departure Time</th>
                  <th>Arrival Time</th>
                  <th>Price</th>
                  {%if login%}
                    {%if login['type']=='customer' or login['type']=='agent'%}
                  <th></th>
                  {%endif%}
                  {%endif%}
              </tr>
          </thead>
          <tbody>
              {% for r in result %}
              <tr>
                  <td>{{r['airline_name']}}</td>
                  <td>{{r['flight_num']}}</td>
                  <td>{{r['departure_airport']}}</td>
                  <td>{{r['arrival_airport']}}</td>
                  <td>{{r['departure_time']}}</td>
                  <td>{{r['arrival_time']}}</td>
                  <td>{{r['price']}}</td>
                  {%if login%}
                    {%if login['type']=='customer' or login['type']=='agent'%}
                  <td class="purchase"><a href="" class="purchase_button" flight_num="{{r['flight_num']}}" airline_name="{{r['airline_name']}}">Purchase</a></td>
                  {%endif%}
                  {%endif%}
              </tr>
              {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <script>
      let purchases = document.querySelectorAll(".purchase_button");
      purchases.forEach(e => {
        e.addEventListener("click",function() {
          if(confirm(`Are you sure to purchase a ticket for flight ${e.getAttribute('flight_num')} at ${e.getAttribute('airline_name')}?`)){
            purchase_flight(e.getAttribute('airline_name'),e.getAttribute('flight_num'));
          }
        });
      });

      function purchase_flight(a_name, f_num){
        const xhr = new XMLHttpRequest();
        const body = {
          airline_name: a_name,
          flight_num: f_num
        }; 
        xhr.open("POST", "/public/purchase_flight");
        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        xhr.onload = () => {
          if (xhr.readyState == 4 && xhr.status == 200) {
            alert("Purchase successfully made!");
          } else {
            alert(`Error: ${xhr.message}`);
          }
        };
        xhr.send(new URLSearchParams(body).toString());
      }
      function toggleSidebar() {
        var sidebar = document.getElementById("sidebar");
        var menu = document.getElementById("menu");
        var header = document.getElementById("header");
        var main = document.getElementById("main");
        var uname = document.getElementById("uname");
        var tb = document.getElementById("tbutton");
        if (menu.style.display == "none") {
            menu.style.display = "block";
            uname.style.display = "block";
            sidebar.style.width = "250px";
            header.style.marginLeft = "250px";
            main.style.marginLeft = "250px";
            tb.innerHTML="<<";

        } else {
            menu.style.display = "none";
            uname.style.display = "none";
            sidebar.style.width = "90px";
            header.style.marginLeft = "90px";
            main.style.marginLeft = "90px";
            tb.innerHTML=">>";
        }
    }
    </script>
  </body>
</html>
